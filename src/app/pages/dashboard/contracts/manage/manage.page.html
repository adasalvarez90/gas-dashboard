<ion-header class="glass-header">
	<ion-toolbar>
		<ion-buttons slot="start">
			<ion-back-button defaultHref="dashboard/contracts"></ion-back-button>
		</ion-buttons>

		<ion-title>
			{{ contract ? 'Editar contrato' : 'Nuevo contrato' }}
		</ion-title>

		<ion-buttons slot="end">
			<ion-button class="save-btn" color="success" [disabled]="!form?.valid"
				(click)="contract ? update() : create()">
				<ion-icon slot="start" name="save"></ion-icon>
				Guardar
			</ion-button>

			@if (contract) {
			<ion-button fill="clear" color="danger" (click)="remove()">
				<ion-icon slot="icon-only" name="trash"></ion-icon>
			</ion-button>
			}
		</ion-buttons>
	</ion-toolbar>
</ion-header>


<ion-content class="contract-manage">
	<ion-grid fixed>
		<ion-row>
			<ion-col size="12">
				<form [formGroup]="form">
					@if (advisorsDic$ | async; as advisorsDic) {
					<!-- PERFIL DEL CONTRATO -->
					<div class="contract-hero">
						<div class="avatar">
							{{ (advisorsDic[form.get('roles.consultant')?.value]?.name || '?')[0] }}
						</div>

						<div class="hero-info">
							<div class="title">
								{{ advisorsDic[form.get('roles.consultant')?.value]?.name || 'Selecciona consultora' }}
							</div>
							<div class="subtitle">
								{{ form.get('investor')?.value || 'Inversionista' }}
							</div>
						</div>

						<ion-toggle color="success" formControlName="signed">
							Firmado
						</ion-toggle>
					</div>
					}

					<!-- ROLES -->
					@if (previewSplits$ | async; as preview) {
					<div class="section roles-section" formGroupName="roles">

						<div class="section-title">Participantes del contrato</div>

						<div class="roles-grid">

							<!-- CONSULTORA -->
							<div class="role-card">
								<div class="role-label">{{ roleLabels.CONSULTANT }}</div>

								<ion-select formControlName="consultant" interface="popover">
									@for (advisor of advisors$ | async; track advisor.uid) {
									<ion-select-option [value]="advisor.uid">
										{{ advisor.name }}
									</ion-select-option>
									}
								</ion-select>

								<div class="preview-percent">
									{{ getPercentForRole('CONSULTANT') }}%
								</div>
							</div>

							<!-- KAM -->
							<div class="role-card">
								<div class="role-label kam">{{ roleLabels.KAM }}</div>

								<ion-select formControlName="kam">
									@for (advisor of advisorsKam$ | async; track advisor.uid) {
									<ion-select-option [value]="advisor.uid">
										{{ advisor.name }}
									</ion-select-option>
									}
								</ion-select>
								<div class="preview-percent">
									{{ getPercentForRole('KAM') }}%
								</div>
							</div>

							<!-- GERENTE -->
							<div class="role-card">
								<div class="role-label manager">{{ roleLabels.MANAGER }}</div>

								<ion-select formControlName="manager">
									@for (advisor of advisorsManager$ | async; track advisor.uid) {
									<ion-select-option [value]="advisor.uid">
										{{ advisor.name }}
									</ion-select-option>
									}
								</ion-select>
								<div class="preview-percent">
									{{ getPercentForRole('MANAGER') }}%
								</div>
							</div>

							<!-- DIRECCIN VENTAS -->
							<div class="role-card">
								<div class="role-label sales">{{ roleLabels.SALES_DIRECTION }}</div>

								<ion-select formControlName="salesDirector">
									@for (advisor of advisorsSales$ | async; track advisor.uid) {
									<ion-select-option [value]="advisor.uid">
										{{ advisor.name }}
									</ion-select-option>
									}
								</ion-select>
								<div class="preview-percent">
									{{ getPercentForRole('SALES_DIRECTION') || 0 }}%
								</div>
							</div>

							<!-- OPERACIONES -->
							<div class="role-card">
								<div class="role-label ops">{{ roleLabels.OPERATIONS }}</div>

								<ion-select formControlName="operations">
									@for (advisor of advisorsOps$ | async; track advisor.uid) {
									<ion-select-option [value]="advisor.uid">
										{{ advisor.name }}
									</ion-select-option>
									}
								</ion-select>
								<div class="preview-percent">
									{{ getPercentForRole('OPERATIONS') }}%
								</div>
							</div>

							<!-- CEO -->
							<div class="role-card ceo">
								<div class="role-label ceo">{{ roleLabels.CEO }}</div>

								<ion-select formControlName="ceo">
									@for (advisor of advisorsCEO$ | async; track advisor.uid) {
									<ion-select-option [value]="advisor.uid">
										{{ advisor.name }}
									</ion-select-option>
									}
								</ion-select>
								<div class="preview-percent">
									{{ getPercentForRole('CEO') }}%
								</div>
							</div>

							<!-- REFERIDORA -->
							@if(form.get('source')?.value === 'REFERIDORA') {
							<div class="role-card referral">
								<div class="role-label referral">{{ roleLabels.REFERRAL }}</div>

								<ion-select formControlName="referral">
									@for (advisor of advisors$ | async; track advisor.uid) {
									<ion-select-option [value]="advisor.uid">
										{{ advisor.name }}
									</ion-select-option>
									}
								</ion-select>
								<div class="preview-percent">
									{{ getPercentForRole('REFERRAL') }}%
								</div>
							</div>
							}

						</div>

					</div>
					}

					<!-- INFORMACIN GENERAL -->
					<div class="section">
						<div class="section-title">Informaci贸n general</div>

						<div class="grid-2">

							<ion-item lines="none">
								<ion-label position="stacked">Inversionista</ion-label>
								<ion-input formControlName="investor"></ion-input>
							</ion-item>

							<ion-item lines="none">
								<ion-label position="stacked">Correo</ion-label>
								<ion-input type="email" formControlName="email"></ion-input>
							</ion-item>

							<ion-item lines="none">
								<ion-label position="stacked">Cuenta cliente</ion-label>
								<ion-input formControlName="clientAccount"></ion-input>
							</ion-item>
						</div>

						<!--  NUEVO: SOURCE -->
						<div class="source-wrapper">
							<div class="source-title">Origen de inversi贸n</div>

							<div class="source-grid">

								@for (s of sources; track s.value) {
								<div class="source-option" [class.active]="form.get('source')?.value === s.value"
									(click)="form.patchValue({ source: s.value })">
									<div class="source-label">
										{{ s.label }}
									</div>
								</div>
								}

							</div>
						</div>

					</div>

					<!-- DATOS FINANCIEROS -->
					<div class="section primary">
						<div class="section-title">Datos financieros</div>

						<div class="grid-4">
							<ion-item lines="none">
								<ion-label position="stacked">Capital (MXN)</ion-label>
								<ion-input type="number" formControlName="capitalMXN"></ion-input>
							</ion-item>

							<ion-item lines="none">
								<ion-label position="stacked">Rendimiento %</ion-label>
								<ion-input type="number" formControlName="yieldPercent"></ion-input>
							</ion-item>

							<ion-item lines="none">
								<ion-label position="stacked">Liquidez</ion-label>
								<ion-input type="number" formControlName="liquidity"></ion-input>
							</ion-item>

							<ion-item lines="none">
								<ion-label position="stacked">Plazo (meses)</ion-label>
								<ion-input type="number" formControlName="term"></ion-input>
							</ion-item>
						</div>
					</div>

					<!-- CONDICIONES -->
					<div class="section">
						<div class="section-title">Condiciones</div>

						<div class="grid-2">
							<ion-item lines="none">
								<ion-label position="stacked">Periodicidad</ion-label>
								<ion-input formControlName="yieldFrequency"></ion-input>
							</ion-item>

							<ion-item lines="none">
								<ion-label position="stacked">Pagos</ion-label>
								<ion-input formControlName="payments"></ion-input>
							</ion-item>

							<ion-item lines="none">
								<ion-label position="stacked">Estado de cuenta</ion-label>
								<ion-input formControlName="accountStatus"></ion-input>
							</ion-item>

							<ion-item lines="none">
								<ion-label position="stacked">Esquema</ion-label>
								<ion-input formControlName="scheme"></ion-input>
							</ion-item>
						</div>
					</div>

					<!-- FIRMA -->
					<div class="section success">
						<div class="section-title">Informaci贸n de firma</div>
						<div class="grid-3">
							<ion-item lines="none">
								<ion-label position="stacked">Fecha de firma</ion-label>
								<ion-input type="text" formControlName="signature"></ion-input>
							</ion-item>

							<ion-item lines="none">
								<ion-label position="stacked">Fecha de deposito</ion-label>
								<ion-input type="text" formControlName="deposit"></ion-input>
							</ion-item>

							<ion-item lines="none">
								<ion-label position="stacked">Cuenta de deposito</ion-label>
								<ion-input type="text" formControlName="depositAccount"></ion-input>
							</ion-item>
						</div>
					</div>

					<!-- DOCUMENTOS -->
					<div class="section">
						<div class="section-title">Documentaci贸n</div>

						<ion-item lines="none">
							<ion-checkbox slot="start" formControlName="docs"></ion-checkbox>
							<ion-label>Documentaci贸n completa</ion-label>
						</ion-item>

						<ion-item lines="none">
							<ion-label position="stacked">Comentarios</ion-label>
							<ion-textarea formControlName="docsComments"></ion-textarea>
						</ion-item>
					</div>

					<!-- BENEFICIARIOS -->
					<div class="section warning">
						<div class="section-title">Beneficiarios</div>
						<ion-textarea formControlName="beneficiaries"></ion-textarea>
					</div>

				</form>
			</ion-col>
		</ion-row>
	</ion-grid>
</ion-content>